name: Create PR from dev to main on version tag

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Create pull request from dev to main
        id: create_pr
        uses: repo-sync/pull-request@v2
        with:
          source_branch: dev
          destination_branch: main
          pr_title: 'ðŸ”€ Release: Merge dev into main'
          pr_body: |
            This PR merges changes from `dev` to `main` after version tag `${{ github.ref_name }}`.
            Auto-generated by GitHub Actions.
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_label: "automated,release"
          pr_assignee: "danijeljw-rpc"
          pr_reviewer: "danijeljw"

      - name: Enable auto-merge for the PR
        if: steps.create_pr.outputs.pr_url != ''
        run: |
          pr_number=$(gh pr list --state open --search "Merge dev into main" --json number -q '.[0].number')
          echo "Enabling auto-merge on PR #$pr_number"
          gh pr merge $pr_number --auto --merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
